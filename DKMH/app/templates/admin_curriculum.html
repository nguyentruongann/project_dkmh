{% load dict_extras %}
{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý chương trình khung</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fb; margin:0; padding:0; }
        .container { max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #0001; padding: 32px;}
        h2 { color: #2185d0; margin-bottom: 20px; }
        form { margin-bottom: 30px;}
        .row { display: flex; flex-wrap: wrap; gap: 20px;}
        .col { flex: 1 1 240px; min-width: 240px;}
        input, select, button {padding: 8px 12px; border-radius: 5px; border:1px solid #d0d6e1; margin-bottom:10px;}
        button { background: #2185d0; color: #fff; border: none; font-weight: bold; cursor: pointer;}
        button:hover { background: #1762a7;}
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px;}
        th, td { border: 1px solid #e5e5e5; padding: 7px 8px; text-align: center;}
        th { background: #f0f6fa;}
        tr:nth-child(even) {background: #f9fbfc;}
        .semester-title {margin-top: 20px; color: #1762a7;}
        .action-btns {display: flex; gap: 6px; justify-content: center;}
        .search-bar { margin-bottom: 24px; display: flex; gap: 8px;}
        .found-list {background:#f4f9fd; border:1px solid #c2d7ea; border-radius:6px; margin-bottom:10px; padding: 12px;}
        .credit-group {display: flex; flex-wrap: wrap; gap: 15px;}
        .credit-field {margin-bottom:10px;}
        .credit-label {display: inline-block; min-width: 90px;}
        @media (max-width: 900px) {
            .row {flex-direction: column;}
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Quản lý chương trình khung</h2>
    {% if messages %}
        {% for message in messages %}
            <div style="background: #ffe4e1; color: #b30000; border-radius: 4px; padding: 10px 15px; margin-bottom: 16px;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Chọn Khoa và Chuyên ngành -->
    <form method="get" class="search-bar">
        <select name="department_id" onchange="this.form.submit()">
            <option value="">-- Chọn khoa --</option>
            {% for dept in all_departments %}
                <option value="{{ dept.departmentId }}" {% if selected_department and selected_department.departmentId == dept.departmentId %}selected{% endif %}>{{ dept.departmentName }}</option>
            {% endfor %}
        </select>
        <select name="major_id" onchange="this.form.submit()">
            <option value="">-- Chọn chuyên ngành --</option>
            {% for m in majors_in_department %}
                <option value="{{ m.majorId }}" {% if selected_major and selected_major.majorId == m.majorId %}selected{% endif %}>{{ m.majorName }}</option>
            {% endfor %}
        </select>
        {% if selected_major %}
            <button type="submit">Xem chương trình</button>
        {% endif %}
    </form>

    {% if selected_major %}
        <!-- Form chỉnh sửa số kỳ, giá tín chỉ và số chỉ từng kỳ -->
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col">
                    <label>Số lượng kỳ:</label>
                    <input type="number" name="total_semesters" value="{{ total_semesters }}" min="1" max="20">
                </div>
                <div class="col">
                    <label>Giá tín chỉ lý thuyết:</label>
                    <input type="number" name="theoretical_credit_price" step="0.01" value="{{ selected_major.theoretical_credit_price }}">
                </div>
                <div class="col">
                    <label>Giá tín chỉ thực hành:</label>
                    <input type="number" name="practical_credit_price" step="0.01" value="{{ selected_major.practical_credit_price }}">
                </div>
            </div>
            <div>
                <b>Thiết lập số tín chỉ từng kỳ:</b>
                <div class="credit-group">
                    {% for sem in range_1_total_semesters %}
                    <div class="credit-field">
                        <span class="credit-label">Kỳ {{ sem }}:</span>
                        <input type="number" name="mandatory_credits_{{ sem }}" min="0" value="{{ credits_per_semester|get_item:sem|get_item:'mandatory' }}">
                        <label> Bắt buộc </label>
                        <input type="number" name="elective_credits_{{ sem }}" min="0" value="{{ credits_per_semester|get_item:sem|get_item:'elective' }}">
                        <label> Tự chọn </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" name="save_major_info">Lưu thông tin chuyên ngành & chỉ từng kỳ</button>
        </form>

        <!-- Upload file chương trình khung -->
        <form method="post" enctype="multipart/form-data" style="margin-bottom: 24px;">
            {% csrf_token %}
            <label><b>Upload chương trình khung ngành: </b></label>
            <input type="file" name="curriculum_file" accept=".csv,.json" required>
            <button type="submit" name="upload_curriculum">Tải lên</button>
            <span style="font-size:12px;color:#666;">(CSV hoặc JSON theo mẫu, hãy chọn đúng chuyên ngành trước khi upload!)</span>
        </form>

        <hr>
        <!-- Thêm môn học vào khung -->
        <form method="post" style="margin-bottom:16px;">
            {% csrf_token %}
            <h3>Thêm môn học vào chương trình khung ngành: {{ selected_major.majorName }}</h3>
            {{ curriculum_form.as_p }}
            <button type="submit" name="add_subject_to_curriculum">Thêm môn học</button>
        </form>

        <hr>
        <!-- Danh sách môn học trong chương trình khung -->
        <h3>Danh sách môn học từng kỳ</h3>
        {% for semester, curriculum_subjects, credits in semester_data %}
            <div class="semester-title">
                Học kỳ {{ semester }} (Bắt buộc: {{ credits.mandatory }} | Tự chọn: {{ credits.elective }})
            </div>
            <table>
                <tr>
                    <th>Tên môn học</th>
                    <th>Tín chỉ LT</th>
                    <th>Tín chỉ TH</th>
                    <th>Bắt buộc?</th>
                    <th>Chỉnh sửa</th>
                    <th>Xóa</th>
                </tr>
                {% for curriculum in curriculum_subjects %}
                <tr>
                    <td>{{ curriculum.subject.subjectName }}</td>
                    <td>{{ curriculum.subject.theoreticalCredits }}</td>
                    <td>{{ curriculum.subject.practiceCredit }}</td>
                    <td>{{ curriculum.is_mandatory|yesno:"Có,Không" }}</td>
                    <td>
                        <form method="post" class="action-btns">
                            {% csrf_token %}
                            <input type="hidden" name="curriculum_id" value="{{ curriculum.curriculumFrameworkId }}">
                            <input type="number" name="semester" value="{{ curriculum.semester }}" min="1" required style="width:50px;">
                            <label>
                                <input type="checkbox" name="is_mandatory" {% if curriculum.is_mandatory %}checked{% endif %}>
                                Bắt buộc
                            </label>
                            <button type="submit" name="edit_curriculum">Lưu</button>
                        </form>
                    </td>
                    <td>
                        <form method="post" onsubmit="return confirm('Bạn chắc chắn muốn xóa môn học này?');" class="action-btns">
                            {% csrf_token %}
                            <input type="hidden" name="curriculum_id" value="{{ curriculum.curriculumFrameworkId }}">
                            <button type="submit" name="delete_curriculum">Xóa</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6">Chưa có môn học nào cho kỳ này.</td></tr>
                {% endfor %}
            </table>
        {% endfor %}
    {% endif %}
</div>
</body>
</html>
